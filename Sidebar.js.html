<script>
var SheetManagerClient = ( function ( namespace ) {
  'use strict';

  var sm = namespace; // namespace

  sm.settings = {
    serverPollInterval: 15000;
  };

  /**
   * Inserts a div that contains an error message after a given element.
   *
   * @param msg The error message to display.
   * @param element The element after which to display the error.
   */
  sm.showError = function ( message, element ) {
    console.log( message );
    var div = $( '.errorFeedback' )
      .text( message );
  };

  /**
   * Populates the sheetlist div with an ordered list of the sheets with management functions
   */
  sm.populateSheets = function ( showHideStates ) {

    var list = $( '<ol></ol>' );

    var listItems = showHideStates.reduce( function ( list, sheet ) {

      var listItem = $( '<li></li>' );

      $( listItem )
        .html( '<span class="sheetname">' + sheet.name + '</span>' );
      $( listItem )
        .attr( 'data-locked', sheet.protections.length > 0 );
      $( listItem )
        .attr( 'data-hidden', sheet.hidden );

      var hiddenState = $( '<span class="hiddenState"><i class="zmdi zmdi-hc-fw" /></span' )
      $( hiddenState )
        .find( 'i' )
        .toggleClass( 'zmdi-eye-off', sheet.hidden );
      $( hiddenState )
        .find( 'i' )
        .toggleClass( 'zmdi-eye', !sheet.hidden );
      $( listItem )
        .append( hiddenState );

      var lockedState = $( '<span class="lockedState"><i class="zmdi zmdi-hc-fw" /></span' )
      $( lockedState )
        .find( 'i' )
        .toggleClass( 'zmdi-lock-open', sheet.protections.length <= 0 );
      $( lockedState )
        .find( 'i' )
        .toggleClass( 'zmdi-lock', sheet.protections.length > 0 );
      $( listItem )
        .append( lockedState );

      var deleteSheet = $( '<span class="deleteSheet"><i class="zmdi zmdi-hc-fw zmdi-delete" /></span>' );
      $( listItem )
        .append( deleteSheet );

      $( list )
        .append( listItem );

      return list;

    }, list );

    $( '.sheetList' )
      .append( listItems );


  };

  // get sheets that exist
  sm.getSheetsInBook = function () {

    return Provoke.run( "SheetManager", "getShowHideStates" )
      .then( function ( result ) {
        SheetManagerClient.populateSheets( result );
      } )[ 'catch' ]( function ( err ) {
        SheetManagerClient.showError( "Error getting sheets", err );
      } );
  };

  sm.looping = function () {
    loopSheetStatuses();

    function loopSheetStatuses() {
      Promise.all( [ sm.getSheetsInBook(), Provoke.loiter( sm.settings.serverPollInterval ) ] )
        .then( function () {
          loopSheetStatuses();
        } );
    }
  };

  return sm;
}( SheetManagerClient || {} ) );

</script>
<script>
/**
 * On document load, assign click handlers to each button and try to load the, populate sheets list
 */
$( function () {

  $( '.sheetList' )
    .on( 'click', '.hiddenState', function () {
      console.log( this );
    } );
  $( '.sheetList' )
    .on( 'click', '.lockedState', function () {
      console.log( this );
    } );
  $( '.sheetList' )
    .on( 'click', '.deleteSheet', function () {
      console.log( this );
    } );

  //    console.log(SheetManagerClient.settings.serverPollInterval);

  //    SheetManagerClient.looping();
} );

</script>
