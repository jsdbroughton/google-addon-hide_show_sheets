<script>
var SheetManagerClient = ( function ( namespace ) {
  'use strict';

  var sm = namespace; // namespace

  sm.settings = {
    serverPollInterval: 5000
  };
  
  sm.volatile = {};

  /**
   * Inserts a div that contains an error message after a given element.
   *
   * @param msg The error message to display.
   * @param element The element after which to display the error.
   */
  sm.showError = function ( message, element ) {
    var div = $( '.errorFeedback' )
      .text( message );
  };

  /**
   * Populates the sheetlist div with an ordered list of the sheets with management functions
   */
  sm.populateSheets = function ( showHideStates ) {

    var list = $( '<ol></ol>' );

    var listItems = showHideStates.reduce( function ( list, sheet ) {

      var listItem = $( '<li></li>' );

      $( listItem )
        .html( '<span class="sheetname">' + sheet.name + '</span>' );
      $( listItem )
        .attr( 'data-locked', sheet.protections.length > 0 );
      $( listItem )
        .attr( 'data-hidden', sheet.hidden );
        
      var hiddenState = $( '<span class="hiddenState"><i class="zmdi zmdi-hc-fw" /></span' )
      $( hiddenState )
        .find( 'i' )
        .toggleClass( 'zmdi-eye-off', !sheet.hidden );
      $( hiddenState )
        .find( 'i' )
        .toggleClass( 'zmdi-eye', sheet.hidden );
      $( listItem )
        .append( hiddenState );

      var lockedState = $( '<span class="lockedState"><i class="zmdi zmdi-hc-fw" /></span' )
      $( lockedState )
        .find( 'i' )
        .toggleClass( 'zmdi-lock-open', sheet.protections.length <= 0 );
      $( lockedState )
        .find( 'i' )
        .toggleClass( 'zmdi-lock', sheet.protections.length > 0 );
      $( listItem )
        .append( lockedState );

      var deleteSheet = $( '<span class="deleteSheet"><i class="zmdi zmdi-hc-fw zmdi-delete" /></span>' );
      $( listItem )
        .append( deleteSheet );

      $( list )
        .append( listItem );

      return list;

    }, list );

    $( '.sheetList' )
      .html( listItems );


  };

  // get sheets that exist
  sm.getSheetsInBook = function () {

    return Provoke.run( "SheetManager", "getShowHideStates" )
      .then( function ( result ) {
        SheetManagerClient.volatile.visibleSheets = result.reduce(function(visibleCount, sheet){
          return (sheet.hidden === false) ? visibleCount += 1 : visibleCount;
        }, 0)
        
        SheetManagerClient.populateSheets( result );
        SheetManagerClient.showError( "" );
      } )
      .catch( function ( err ) {
        SheetManagerClient.showError( err || "Error getting sheets");
      } );
  };

  sm.loop = function () {
    loopSheetStatuses();

    function loopSheetStatuses() {
      Promise.all( [ sm.getSheetsInBook(), Provoke.loiter( sm.settings.serverPollInterval ) ] )
        .then( function () {
          loopSheetStatuses();
        } );
    }
  };

  return sm;
}( SheetManagerClient || {} ) );

</script>


<script>
/**
 * On document load, assign click handlers to each button and try to load the, populate sheets list
 */
$( function () {

  $( '.sheetList' )
    .on( 'click', '.hiddenState', function () {
    
      var li = $(this).parent();
      
      var locked = $(li).attr('data-locked') === 'true';
      var hidden = $(li).attr('data-hidden') === 'true';
      var name = $(li).find('.sheetname').text();
      var index = $(li).index() + 1;
          
      if (!hidden && SheetManagerClient.volatile.visibleSheets <= 1) {
        SheetManagerClient.showError("Cannot hide last visible sheet");
      } else {
        $(li).find('.hiddenState i').toggleClass( 'zmdi-eye-off').toggleClass( 'zmdi-eye')
        $(li).attr('data-hidden', $(li).attr('data-hidden') === 'false')
        Provoke.run( "SheetManager", "toggleSheet", name, index)
        .then ( function( result ) {

          

        } )
        .catch( function ( err ) {
          SheetManagerClient.showError( err || "Error toggling sheet");
        } );
      }
      
    } );
  $( '.sheetList' )
    .on( 'click', '.lockedState', function () {
      console.log( this );
    } );
  $( '.sheetList' )
    .on( 'click', '.deleteSheet', function () {
      console.log( this );
    } );

    console.log('Polling at ' + SheetManagerClient.settings.serverPollInterval / 1000 + ' seconds');

    SheetManagerClient.loop();
} );

</script>
