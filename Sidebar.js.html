<script>
/*global $, Provoke, ArrayBuffer, DataView, Float32Array, Float64Array, Int8Array, Int16Array, Int32Array, Intl, Map, Promise, Proxy, Reflect, Set, Symbol, System, Uint8Array, Uint8ClampedArray, Uint16Array, Uint32Array, WeakMap, WeakSet */
/*jslint browser:true, maxerr:10, fudge:true */
/*eslint no-console: ["error", { allow: ["warn", "log"] }] */
var SheetManagerClient = (function (namespace) {
    'use strict';

    var sm = namespace;

    sm.settings = {
        serverPollInterval: 10000
    };

    /**
     * Placeholder for in memory values
     */
    sm.volatile = {};

    /**
     * Inserts a div that contains an error message after a given element.
     *
     * @param msg The error message to display.
     * @param element The element after which to display the error.
     */
    sm.showError = function (message) {
        $('.errorFeedback')
            .text(message);
    };

    /**
     * Populates the sheetlist div with an ordered list of the sheets with management functions
     */
    sm.populateSheets = function (showHideStates) {

        var list = $('<ol></ol>'),
            listItems = showHideStates.reduce(function (list, sheet) {

                var listItem, hiddenState, deleteSheet, lockedState;

                // Each <li> per sheet.
                listItem = $('<li></li>');
                $(listItem)
                    .html('<span class="sheetname">' + sheet.name + '</span>');

                // html5 data-* attributes
                $(listItem)
                    .attr('data-locked', sheet.protections.length > 0);
                $(listItem)
                    .attr('data-hidden', sheet.hidden);

                // add toggle hidden state button
                hiddenState = $('<span class="hiddenState"><i class="zmdi zmdi-hc-fw" /></span');
                $(hiddenState)
                    .find('i')
                    .toggleClass('zmdi-eye-off', !sheet.hidden);
                $(hiddenState)
                    .find('i')
                    .toggleClass('zmdi-eye', sheet.hidden);
                $(listItem)
                    .append(hiddenState);

                // add view locked hidden state icon
                deleteSheet = $('<span class="deleteSheet"><i class="zmdi zmdi-hc-fw zmdi-delete" /></span>');
                $(listItem)
                    .append(deleteSheet);
                $(list)
                    .append(listItem);

                // add view locked hidden state icon
                lockedState = $('<span class="lockedState"><i class="zmdi zmdi-hc-fw" /></span');
                $(lockedState)
                    .find('i')
                    .toggleClass('zmdi-lock-open', sheet.protections.length <= 0);
                $(lockedState)
                    .find('i')
                    .toggleClass('zmdi-lock', sheet.protections.length > 0);
                $(listItem)
                    .append(lockedState);

                return list;
            }, list);

        $('.sheetList')
            .html(listItems);
    };

    // get sheets that exist
    sm.getSheetsInBook = function () {

        return Provoke.run('SheetManager', 'getShowHideStates')
            .then(function (result) {
                sm.volatile.visibleSheets = result.reduce(function (visibleCount, sheet) {

                    if (sheet.hidden === false) {
                        visibleCount += 1;
                    }
                    return visibleCount;
                }, 0);

                sm.populateSheets(result);
                sm.showError('');
            })
            .catch(function (err) {
                sm.showError(err || 'Error getting sheets');
            });
    };

    sm.loop = function () {

        function loopSheetStatuses() {
        
            Promise.all([sm.getSheetsInBook(), Provoke.loiter(sm.settings.serverPollInterval)])
                .then(function () {
                    if (!sm.volatile.interrupt) {
                      loopSheetStatuses();
                    }
                });
            }
        
        loopSheetStatuses();
    };

    return sm;
}({}));

/**
 * On document load, assign click handlers to each button and try to load the, populate sheets list
 */
$(function () {
    'use strict';
    $('.sheetList')
        .on('click', '.hiddenState', function (e) {

            var li, hidden, name, index;
            
            li = $(e.currentTarget)
                .parent('li');

            hidden = $(li)
                .attr('data-hidden') === 'true';
            name = $(li)
                .find('.sheetname')
                .text();
            index = $(li)
                .index() + 1;

            if (!hidden && SheetManagerClient.volatile.visibleSheets <= 1) {
                SheetManagerClient.showError('Cannot hide last visible sheet');
            } else {
            
                SheetManagerClient.volatile.interrupt = true;
                          
                Provoke.run('SheetManager', 'toggleSheet', name, index)
                    .then(function(result) {
                      SheetManagerClient.showError('');
                      SheetManagerClient.populateSheets(result)
                      SheetManagerClient.volatile.interrupt = false;
                      SheetManagerClient.loop();
                    })
                    .catch(function (err) {
                        SheetManagerClient.showError(err || 'Error toggling sheet');
                    });
            }
        });

    $('.sheetList')
        .on('click', '.deleteSheet', function (e) {
            console.log(e.target);
        });

    console.log('Polling at ' + SheetManagerClient.settings.serverPollInterval / 1000 + ' seconds');

    SheetManagerClient.loop();
});
</script>